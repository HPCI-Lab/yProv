# Precipitation Trend Analysis

The multi-model Precipitation Trend Analysis is an example of climate models intercomparison data analysis consisting of hundreds of micro-tasks. The workflow includes two main stages:
- a single-model step, which evaluates and compares the precipitation trends for both the historical and future scenario data;
- a multi-model step, performing the ensemble analysis on the trend comparison data and the computation of five statistical indicators. 

This use case has been implemented by using the [Ophidia](https://ophidia.cmcc.it) High Performance Data Analytics framework developed by [CMCC](https://www.cmcc.it).

The following commands show how to exploit the yProv service and its RESTful API to load the W3C PROV-compliant JSON document generated by Ophidia and perform some basic operations against the associated provenance graph database running on the back-end.

- Register to the yProv service
```
curl -X POST http://localhost:3000/api/v0/auth/register -H 'Content-Type: application/json' -d '{"user": “...”, "password": "..."}'
```

- Log in to the service to get a valid token for performing all the other operations
```
curl -X POST http://localhost:3000/api/v0/auth/login -H 'Content-Type: application/json' -d '{"user": "...", "password": "..."}'
```

- Load the JSON document associated to the PTA use case
```
curl -X PUT  http://localhost:3000/api/v0/documents/pta -H "Content-Type: application/json" -H 'Authorization: Bearer <token>' -d @pta.json
```

- Get the list of all the available provenance documents (this is the only operations not requiring a token)
```
curl -X GET  http://localhost:3000/api/v0/documents -H "Content-Type: application/json"
```
 
- Get the full document associated to the PTA
```
curl -X GET  http://localhost:3000/api/v0/documents/pta -H "Content-Type: application/json"
```

- Given a specific node identified by its id (e.g., ophidia:http://127.0.0.1/ophidia/66/7191), get the corresponding subgraph
```
curl -X GET  http://localhost:3000/api/v0/documents/pta/subgraph?id=ophidia:http://127.0.0.1/ophidia/66/7191
```

Alternatively, you can use the `yProv CLI` to interact with the `yProv` service. Please refer to [this documentation](https://github.com/HPCI-Lab/yProv-CLI/tree/main) to install the CLI. 
These are the corresponding CLI commands to get started with the PTA use case.

- Set up the environment variables
```
export YPROV_ADDR=http://localhost
export YPROV_PORT=3000
```

- Register to the yProv service
```
yprov-cli auth register --user myUsername --password myPassword
```

- Log in to the service to get a valid token for performing all the other operations
```
yprov-cli auth login --user myUsername --password myPassword
```

- Export the `YPROV_TOKEN` (not needed for read operations)
```
export YPROV_TOKEN=[TOKEN]
```

- Load the JSON document associated to the PTA use case
```
yprov-cli documents create --doc-id pta --file @pta.json
```

- Get the list of all the available provenance documents (this is the only operations not requiring a token)
```
yprov-cli documents get
```
 
- Get the full document associated to the PTA
```
yprov-cli documents get --doc-id pta
```

- Given a specific node identified by its id (e.g., ophidia:http://127.0.0.1/ophidia/66/7191), get the corresponding subgraph
```
yprov-cli documents subgraph --doc-id pta --e-id ophidia:http://127.0.0.1/ophidia/66/7191
```